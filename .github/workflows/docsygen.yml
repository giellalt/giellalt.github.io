name: Build in-code documentation
on:
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: giellalt/giellalt.github.io

      - name: Install realpath
        run: |
          which realpath

      - name: Setup Node.js for Slidev
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install Slidev and dependencies
        run: |
          npm install -g @slidev/cli
          npm install -g @slidev/theme-default
          npm install -g playwright-chromium

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Build Slidev presentations
        env:
          CI: true
          NODE_ENV: production
        run: |
          # Find all markdown files that should have slidev presentations
          find . -name "*.md" -not -path "./_*" -not -path "./node_modules/*" | while read mdfile; do
            basename=$(basename "$mdfile" .md)
            dirname=$(dirname "$mdfile")
            slidev_dir="${dirname}/${basename}-slidev"
            
            # Check if there are any links to this slidev/dist directory in the site
            if grep -r "${basename}-slidev/dist/" . --include="*.md" --include="*.html" > /dev/null 2>&1; then
              echo "Building Slidev presentation for $mdfile -> $slidev_dir (triggered by ${basename}-slidev/dist/ link)"
              mkdir -p "$slidev_dir"
              
              # Copy and adapt the markdown for Slidev
              echo "---" > "$slidev_dir/slides.md"
              echo "theme: seriph" >> "$slidev_dir/slides.md"
              echo "background: https://source.unsplash.com/1920x1080/?nature,water" >> "$slidev_dir/slides.md"
              echo "class: text-center" >> "$slidev_dir/slides.md"
              echo "highlighter: shiki" >> "$slidev_dir/slides.md"
              echo "lineNumbers: false" >> "$slidev_dir/slides.md"
              echo "info: |" >> "$slidev_dir/slides.md"
              echo "  Presentation generated from $(basename $mdfile)" >> "$slidev_dir/slides.md"
              echo "drawings:" >> "$slidev_dir/slides.md"
              echo "  persist: false" >> "$slidev_dir/slides.md"
              echo "---" >> "$slidev_dir/slides.md"
              echo "" >> "$slidev_dir/slides.md"
              
              # Copy images directory FIRST, before processing content
              if [ -d "images" ]; then
                cp -r images "$slidev_dir/"
                echo "Copied images directory to $slidev_dir"
              fi
              
              # Convert markdown content for Slidev format and fix image paths
              echo "=== Processing markdown content ==="
              echo "Before conversion:"
              tail -n +2 "$mdfile" | head -10
              
              # Process content in steps for better debugging
              tail -n +2 "$mdfile" > "$slidev_dir/temp.md"
              sed 's/^# /---\n\n# /' "$slidev_dir/temp.md" > "$slidev_dir/temp2.md"
              sed 's|/images/|./images/|g' "$slidev_dir/temp2.md" > "$slidev_dir/temp3.md"
              sed 's|\.\.\/images\/|\.\/images\/|g' "$slidev_dir/temp3.md" >> "$slidev_dir/slides.md"
              
              # Clean up temp files
              rm -f "$slidev_dir/temp.md" "$slidev_dir/temp2.md" "$slidev_dir/temp3.md"
              
              echo "=== Generated slides.md content (image references) ==="
              grep -n "images/" "$slidev_dir/slides.md" || echo "No image references found"
              
              # Build the presentation
              cd "$slidev_dir"
              echo "yes" | slidev build slides.md --base "/${basename}-slidev/dist/" --out dist
              
              # Ensure images are available in the built presentation
              if [ -d "images" ] && [ -d "dist" ]; then
                cp -r images dist/
                echo "Copied images to dist directory for runtime access"
              fi
              
              cd - > /dev/null
              
              # Remove slides.md to prevent Jekyll from processing it
              rm "$slidev_dir/slides.md"
              echo "Removed slides.md from $slidev_dir to prevent Jekyll conflicts"
            fi
          done

      - name: Build Jekyll site
        env:
          JEKYLL_GITHUB_TOKEN: ${{ secrets.GIELLALT_DOCS_GH_TOKEN }}
        run: |
          echo "=== Starting Jekyll build ==="
          bundle exec jekyll build --verbose
          echo "=== Jekyll build complete ==="
          echo "Checking what Jekyll generated in _site:"
          ls -la _site/ | grep -E "(slidev|presentation)" || echo "No Slidev directories found in _site"

      - name: Note about Slidev presentations
        run: |
          echo "=== Slidev presentations are handled by Jekyll as static files ==="
          echo "Jekyll automatically copies *-slidev/dist/ directories to _site/"
          echo "No additional copying needed - presentations will be available at:"
          echo "  https://giellalt.github.io/test-presentation-slidev/dist/"

      - name: deploy gh pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: _site
          enable_jekyll: false
