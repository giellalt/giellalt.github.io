{% comment %}Bygg hierarkisk sitemap{% endcomment %}

{% assign root_items = "" | split: "" %}
{% assign dir_items = "" | split: "" %}

{% comment %}Debug index-filer{% endcomment %}
<div style="display:none">
<p>Alle index-filer:</p>
{% for page in site.pages %}
    {% assign filename = page.url | split: '/' | last %}
    {% if filename == 'index.html' or filename == 'index.md' %}
        <p>Index-fil: {{ page.url }} - Title: {{ page.title }}</p>
    {% endif %}
{% endfor %}
</div>

{% comment %}Hent og sorter sider{% endcomment %}
{% for page in site.pages %}
    {% assign url_parts = page.url | split: '/' %}
    {% assign filename = url_parts.last %}
    {% unless filename contains 'google' or page.url contains '.xml' or page.url contains '.css' or page.url contains 'assets/' or page.url contains '.json' or filename == '' %}
        {% capture title %}
            {% if page.title and page.title != '' %}
                {{ page.title }}
            {% else %}
                {% assign path_without_ext = page.url | remove: '.html' | remove: '.md' | remove: 'index' %}
                {% assign last_part = path_without_ext | split: '/' | last %}
                {% if last_part == '' %}
                    {% assign path_parts = path_without_ext | split: '/' %}
                    {% assign dir_name = path_parts[-2] | capitalize %}
                    {{ dir_name }}
                {% else %}
                    {% assign words = last_part | replace: '/([A-Z])/g', ' $1' | replace: '([a-z])([A-Z])', '$1 $2' %}
                    {{ words | capitalize }}
                {% endif %}
            {% endif %}
        {% endcapture %}
        {% assign item = "" | split: "" %}
        {% assign item = item | push: page.url %}
        {% assign item = item | push: title %}
        
        {% assign url_parts_size = url_parts | size %}
        {% if url_parts_size < 3 %}
            {% assign root_items = root_items | push: item %}
        {% else %}
            {% assign dir_items = dir_items | push: item %}
        {% endif %}
    {% endunless %}
{% endfor %}

<!-- Debug: Start -->
<div style="display:none">
<p>Debugging site.pages:</p>
{% for page in site.pages %}
  <p>URL: {{ page.url }} - Title: {{ page.title }}</p>
{% endfor %}

<p>Root items:</p>
{% for item in root_items %}
  <p>URL: {{ item[0] }} - Title: {{ item[1] }}</p>
{% endfor %}

<p>Directory items:</p>
{% for item in dir_items %}
  <p>URL: {{ item[0] }} - Title: {{ item[1] }}</p>
{% endfor %}
</div>
<!-- Debug: End -->

<ul>
{% comment %}Rotfiler{% endcomment %}
{% for item in root_items %}
    <li>
        <a href="{{ site.baseurl }}{{ item[0] | remove: 'index.html' | remove: 'index.md' }}">{{ item[1] }}</a>
    </li>
{% endfor %}

{% comment %}Samle alle unike katalogar{% endcomment %}
{% assign seen_dirs = "" | split: "" %}
{% assign all_dirs = "" | split: "" %}
{% for item in dir_items %}
    {% assign url = item[0] %}
    {% assign url_parts = url | split: '/' %}
    {% assign current_path = "" %}
    {% assign url_parts_size = url_parts | size %}
    {% assign max_index = url_parts_size | minus: 1 %}
    {% for i in (1..max_index) %}
        {% assign current_path = current_path | append: '/' | append: url_parts[i] %}
        {% unless seen_dirs contains current_path %}
            {% assign all_dirs = all_dirs | push: current_path %}
            {% assign seen_dirs = seen_dirs | push: current_path %}
        {% endunless %}
    {% endfor %}
{% endfor %}
{% assign all_dirs = all_dirs | sort %}

{% comment %}Finn toppnivå-katalogar{% endcomment %}
{% assign top_level_dirs = "" | split: "" %}
{% for dir in all_dirs %}
    {% assign parts = dir | split: '/' %}
    {% assign dir_depth = parts | size %}
    {% if dir_depth < 3 %}
        {% assign top_level_dirs = top_level_dirs | push: dir %}
    {% endif %}
{% endfor %}

{% comment %}Start med toppnivå-katalogar{% endcomment %}
{% assign sorted_dir = dir_items | sort %}

{% for top_dir in top_level_dirs %}
    {% assign dir_name = top_dir | split: '/' | last %}
    <li>
        {% if dir_name == 'lang' %}
            <!-- Debug for lang/ -->
            <div style="display:none">
            <p>Debugging lang/ katalog:</p>
            <p>top_dir: {{ top_dir }}</p>
            <p>Søker etter: {{ top_dir | append: '/index.html' }} eller {{ top_dir | append: '/index.md' }}</p>
            {% for page in site.pages %}
                {% if page.url contains '/lang/' %}
                    <p>Fann side: {{ page.url }} - Title: {{ page.title }}</p>
                {% endif %}
            {% endfor %}
            </div>
        {% endif %}
        
        {% assign dir_index = nil %}
        {% assign dir_title = dir_name | capitalize %}
        {% for page in site.pages %}
            {% if page.url == top_dir | append: '/index.html' or page.url == top_dir | append: '/index.md' %}
                {% assign dir_index = page %}
                {% if page.title and page.title != '' %}
                    {% assign dir_title = page.title %}
                {% endif %}
                {% break %}
            {% endif %}
        {% endfor %}

        <a href="{{ site.baseurl }}{{ top_dir }}/">{{ dir_title }}</a>
        <ul>
        {% comment %}Filer direkte i denne katalogen{% endcomment %}
        {% for item in dir_items %}
            {% assign url_parts = item[0] | split: '/' %}
            {% assign item_dir_parts = url_parts | pop %}
            {% assign item_dir = item_dir_parts | join: '/' %}
            {% if item_dir == top_dir %}
                <li>
                    <a href="{{ site.baseurl }}{{ item[0] | remove: 'index.html' | remove: 'index.md' }}">{{ item[1] }}</a>
                </li>
            {% endif %}
        {% endfor %}

        {% comment %}Debug nivå 2{% endcomment %}
        <div style="display:none">
            <p>Debug START nivå 2: for {{ top_dir }}:</p>
            <p>Files in this dir:</p>
            {% for item in sorted_dir %}
                {% assign url = item[0] %}
                {% assign url_parts = url | split: '/' %}
                {% assign item_dir_parts = url_parts | pop %}
                {% assign item_dir = item_dir_parts | join: '/' %}
                {% if item_dir == top_dir %}
                    <p>URL: {{ url }} - Title: {{ item[1] }}</p>
                {% endif %}
            {% endfor %}
            
            <p>Debug: Potential subdirs:</p>
            {% for dir in all_dirs %}
                {% if dir contains top_dir and dir != top_dir %}
                    <p>{{ dir }}</p>
                {% endif %}
            {% endfor %}
            <p>Debug SLUTT nivå 2</p>
        </div>

        {% comment %}Underkatalogar{% endcomment %}
        {% assign subdirs = "" | split: "" %}
        {% for dir in all_dirs %}
            {% if dir contains top_dir and dir != top_dir %}
                {% assign dir_parts = dir | split: '/' %}
                {% assign last_part = dir_parts | last %}
                {% unless last_part contains '.html' or last_part contains '.md' %}
                    {% assign parent_path = dir_parts | pop | join: '/' %}
                    {% if parent_path == top_dir %}
                        {% assign subdirs = subdirs | push: dir %}
                    {% endif %}
                {% endunless %}
            {% endif %}
        {% endfor %}

        {% for subdir in subdirs %}
            {% assign subdir_name = subdir | split: '/' | last %}
            <li>
                {% if subdir contains '/lang/smi' %}
                    <!-- Debug for lang/smi/ -->
                    <div style="display:none">
                    <p>Debugging lang/smi/ katalog:</p>
                    <p>subdir: {{ subdir }}</p>
                    <p>Søker etter: {{ subdir | append: '/index.html' }} eller {{ subdir | append: '/index.md' }}</p>
                    {% for page in site.pages %}
                        {% if page.url contains '/lang/smi/' %}
                            <p>Fann side: {{ page.url }} - Title: {{ page.title }}</p>
                        {% endif %}
                    {% endfor %}
                    </div>
                {% endif %}

                {% assign dir_index = nil %}
                {% assign dir_title = subdir_name | capitalize %}
                {% for page in site.pages %}
                    {% if page.url == subdir | append: '/index.html' or page.url == subdir | append: '/index.md' %}
                        {% assign dir_index = page %}
                        {% if page.title and page.title != '' %}
                            {% assign dir_title = page.title %}
                        {% endif %}
                        {% break %}
                    {% endif %}
                {% endfor %}

                <a href="{{ site.baseurl }}{{ subdir }}/">{{ dir_title }}</a>
                <ul>
                {% comment %}Filer i denne underkatalogen{% endcomment %}
                {% for item in sorted_dir %}
                    {% assign url = item[0] %}
                    {% assign title = item[1] | strip %}
                    {% assign url_parts = url | split: '/' %}
                    {% assign item_dir_parts = url_parts | pop %}
                    {% assign item_dir = item_dir_parts | join: '/' %}
                    {% if item_dir == subdir %}
                        {% assign filename = url_parts | last %}
                        <li>
                            <a href="{{ site.baseurl }}{{ url | remove: 'index.html' | remove: 'index.md' }}">{{ title }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% comment %}Debug nivå 3{% endcomment %}
                <div style="display:none">
                    <p>Debug START nivå 3: for {{ subdir }}:</p>
                    <p>Files in this dir:</p>
                    {% for item in sorted_dir %}
                        {% assign url = item[0] %}
                        {% assign url_parts = url | split: '/' %}
                        {% assign item_dir_parts = url_parts | pop %}
                        {% assign item_dir = item_dir_parts | join: '/' %}
                        {% if item_dir == subdir %}
                            <p>URL: {{ url }} - Title: {{ item[1] }} (Raw filename: {{ url_parts | last }})</p>
                        {% endif %}
                    {% endfor %}
                    
                    <p>Potential level 3 subdirs:</p>
                    {% for dir in all_dirs %}
                        {% if dir contains subdir and dir != subdir %}
                            {% assign dir_parts = dir | split: '/' %}
                            {% assign parent_path = dir_parts | pop | join: '/' %}
                            {% if parent_path == subdir %}
                                <p>{{ dir }} (Last part: {{ dir_parts | last }})</p>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                <p>Debug SLUTT nivå 3</p>
                </div>

                {% comment %}Debug nivå 3{% endcomment %}
                <div style="display:none">
                    <p>Debug START nivå 3: for {{ subdir }}:</p>
                    <p>Files in this dir:</p>
                    {% for item in sorted_dir %}
                        {% assign url = item[0] %}
                        {% assign title = item[1] %}
                        {% assign url_parts = url | split: '/' %}
                        {% assign item_dir_parts = url_parts | pop %}
                        {% assign item_dir = item_dir_parts | join: '/' %}
                        {% if item_dir == subdir %}
                            <p>URL: {{ url }} - Title: {{ title | strip }}</p>
                        {% endif %}
                    {% endfor %}
                    <p>Potential level 3 subdirs:</p>
                    {% for dir in all_dirs %}
                        {% if dir contains subdir and dir != subdir %}
                            {% assign dir_parts = dir | split: '/' %}
                            {% assign last_part = dir_parts | last %}
                            {% unless last_part contains '.html' or last_part contains '.md' %}
                                {% assign parent_path = dir_parts | pop | join: '/' %}
                                {% if parent_path == subdir %}
                                    <p>{{ dir }} (Last part: {{ last_part }})</p>
                                {% endif %}
                            {% endunless %}
                        {% endif %}
                    {% endfor %}
                    <p>Debug SLUTT nivå 3</p>
                </div>

                {% comment %}Under-underkatalogar{% endcomment %}
                {% assign subsubdirs = "" | split: "" %}
                {% for dir in all_dirs %}
                    {% if dir contains subdir and dir != subdir %}
                        {% assign dir_parts = dir | split: '/' %}
                        {% assign last_part = dir_parts | last %}
                        {% unless last_part contains '.html' or last_part contains '.md' %}
                            {% assign parent_path = dir_parts | pop | join: '/' %}
                            {% if parent_path == subdir %}
                                {% assign subsubdirs = subsubdirs | push: dir %}
                            {% endif %}
                        {% endunless %}
                    {% endif %}
                {% endfor %}

                {% for subsubdir in subsubdirs %}
                    {% assign subsubdir_name = subsubdir | split: '/' | last %}
                    <li>
                        {% assign dir_index = nil %}
                        {% for page in site.pages %}
                            {% if page.url == subsubdir | append: '/index.html' or page.url == subsubdir | append: '/index.md' %}
                                {% assign dir_index = page %}
                                {% break %}
                            {% endif %}
                        {% endfor %}

                        {% if dir_index %}
                            <a href="{{ site.baseurl }}{{ subsubdir }}/">{% if dir_index.title %}{{ dir_index.title }}{% else %}{{ subsubdir_name | capitalize }}{% endif %}</a>
                        {% else %}
                            <strong>{{ subsubdir_name | capitalize }}</strong>
                        {% endif %}
                        <ul>
                        {% comment %}Filer i denne under-underkatalogen{% endcomment %}
                        {% for item in sorted_dir %}
                            {% assign url = item[0] %}
                            {% assign title = item[1] %}
                            {% assign url_parts = url | split: '/' %}
                            {% assign item_dir_parts = url_parts | pop %}
                            {% assign item_dir = item_dir_parts | join: '/' %}
                            {% if item_dir == subsubdir %}
                                {% assign filename = url_parts | last %}
                                <li>
                                    <a href="{{ site.baseurl }}{{ url | remove: 'index.html' | remove: 'index.md' }}">{{ title }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}
                        </ul>
                    </li>
                {% endfor %}
                </ul>
            </li>
        {% endfor %}
        </ul>
    </li>
{% endfor %}
</ul>
